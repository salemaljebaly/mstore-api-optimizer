name: Auto Tag

on:
  push:
    branches: [ main ]

jobs:
  auto-tag:
    name: Create Tag from Plugin Version
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Get plugin version
      id: version
      run: |
        VERSION=$(grep "Version:" mstore-api-optimizer.php | sed 's/.*Version: *//' | tr -d ' ')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Plugin version: $VERSION"
    
    - name: Check if tag exists
      id: tag-check
      run: |
        if git tag -l | grep -q "^v${{ steps.version.outputs.version }}$"; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Tag v${{ steps.version.outputs.version }} already exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Tag v${{ steps.version.outputs.version }} does not exist"
        fi
    
    - name: Create and push tag
      if: steps.tag-check.outputs.exists == 'false'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git tag -a "v${{ steps.version.outputs.version }}" -m "Release version ${{ steps.version.outputs.version }}"
        git push origin "v${{ steps.version.outputs.version }}"
        
        echo "✅ Created and pushed tag v${{ steps.version.outputs.version }}"
    
    - name: Skip tagging
      if: steps.tag-check.outputs.exists == 'true'
      run: echo "⏭️ Skipping - tag already exists"